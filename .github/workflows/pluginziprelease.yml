name: Build and Upload ZIP on Release

on:
  release:
    types: [created]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Create combined ZIP
        run: |
          mkdir combined
          rsync -av --exclude='combined' ./ ./combined/
          cd combined
          zip -r ../repo_with_submodules.zip .

      - name: Upload ZIP to release with custom display name
        run: |
          gh release upload ${{ github.event.release.tag_name }} \
            repo_with_submodules.zip \
            --name "Source code (all)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
